# Redis持久化
* 备份是如何执行的？
Redis会单独创建(fork)一个紫禁城来进行持久化，会先将数据写入到一个临时文件中，待持久化过程都结束了，
再用这个临时文件替换上次持久化好的文件。整个过程中，主进程是不进行任何IO操作的，这就确保了极高的性能，
如果需要进行大规模数据的恢复，且对于数据的恢复的完整性不是非常敏感，那么RDB方式要比AOF方式更加高效。RDB
的缺点是最后一次持久化后的数据不能丢失。


* Fork
fork的作用就是复制一个与当前进程一样的进程。新的进程是所有数据(遍历，环境遍历，程序计数器等)数值都和员进程一直，但是，是一个全新的
进程，并作为原进程的子进程。

在linux程序中,fork()会产生一个和父进程完全相同的子进程，但子进程在此后多次会exec系统调用，处于效率考虑，Linux引入了"写时复制技术"

一般情况下父进程和进程会共用同一段物理内存，只有进程空间的隔断的内容发生变化时，才会将父进程的内容复制一份给子进程。





## RDB
RDB是在指定的时间间隔内将内存中的数据集快照写入磁盘，也就是行话将的Snapshot快照，
它恢复是是将快照文件直接读到内存里。

rdb相关的配置
```shell script
# 硬盘写满了就报错无法写入
stop-writes-on-bgsave-error yes

# RDB压缩
rdbcompression yes
# RDB校验和，如何开启了校验，大约会增加10% 的性能消耗，如果希望获取最大的性能提升，可以关闭此功能。
rdbchecksum yes
# rdb快照文件名字
dbfilename dump.rdb
# 文件存放的为止
dir ./

```

* 优势：
    *　适合大规模的数据恢复
    * 对于数据完整性和一致性要求不搞更适合使用
    *　节省磁盘空间
    * 恢复速度快。
*　劣势
    * fork的时候，内存中的数据被克隆了一份，大致2倍的膨胀性需要考虑。
    * 虽然Redis在fork的时候使用了写时拷贝技术，但是如果数据庞大的时候时比较消耗性能的。
    * 在备份周期在一定时间间隔做一次备份，如果redis服务以为的down了化，就会丢失最后一次的快照后的所有的修改。
        


## AOF
AOF是以日志的形式来记录每个写操作(增量保存)，将Redis执行的所有写指令记录下来(读操作不记录)，
只许追加文件，但不可以改写文件，redis启动指出会读取改文件重新构建数据，换言之，redis重启的话
就根据日志文件的内容将写指令从前到后执行一次以完成数据的恢复工作。




如果AOF和RDB都开启了，那么redis会默认的选择AOF优先.