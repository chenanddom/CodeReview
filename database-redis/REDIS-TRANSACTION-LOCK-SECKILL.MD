# Redis事务-锁-秒杀
## 事务
Redis事务师一个单独的隔离操作：事务中所有的命令都会序列化，按照是顺序执行。事务在执行的过程中，不回被其他的客户端
发送过来的命令请求打断。
Redis事务的主要作用就是串联多个明客防止别的命令插队

### Multi、Exec、discard
从输入Multi命令开始，输入的命令都会依次的进入命令队列中，但是不会执行，直到输入Exec后，Redis命令会将之前的命令队列中的命令依次执行，
组队的过程中可以通过discard来放弃组队。

注意：
```text
如果在组队中有任何一个命令执行出错，那么就本次事务就无法执行exec就出错回滚了
如果在组队过程中是成功的，但是命令的执行Exec的时候就集训执行正确的，错误的提示错误。
```
例子：
```shell script
192.168.0.199:6379> multi
OK
192.168.0.199:6379(TX)> set k1 v1
QUEUED
192.168.0.199:6379(TX)> set k2 v2
QUEUED
# 组队失败
192.168.0.199:6379(TX)> set k2
(error) ERR wrong number of arguments for 'set' command
# 组队失败执行整个队列里面的命令都会失败
192.168.0.199:6379(TX)> exec
(error) EXECABORT Transaction discarded because of previous errors.
# ----------------------------------------------------------------------
192.168.0.199:6379> multi
OK
192.168.0.199:6379(TX)> set k1 v1 
QUEUED
192.168.0.199:6379(TX)> set k2  v2
QUEUED
# 执行会出错的指令，提交没问题
192.168.0.199:6379(TX)> incr k1
QUEUED
# 组队成功，那么在exec的执行后阶段就执行正确的指令，提示错误的指令。
192.168.0.199:6379(TX)> exec
1) OK
2) OK
3) (error) ERR value is not an integer or out of range
192.168.0.199:6379> keys *
1) "k2"
2) "k1"

```

### 事务的冲突

* 悲观锁

* 乐观锁
示例：
```shell script
---------------client1-----------------------------------------------------------------
# 监控键k1
192.168.0.199:6379> watch k1
OK
# 组队-开启事务
192.168.0.199:6379> multi
OK
192.168.0.199:6379(TX)> set k1 v1
QUEUED
# 提交事务
192.168.0.199:6379(TX)> exec
1) OK
192.168.0.199:6379> 
--------------client2----------------------------------------------------
# 监控键k1
192.168.0.199:6379> watch k1
OK
# 组队-开启事务
192.168.0.199:6379> multi
OK
192.168.0.199:6379> set k1 v1
QUEUED
# 提交事务
192.168.0.199:6379> exec
# 返回nil表示失败
(nil)
```

*　Redis事务的三大特性
    * 单独的隔离操作
        * 事务中的所有命令都会序列化，按顺序地执行。事务在执行的过程中，不会被其他客户端发送过来的命令请求打断
    * 没有隔离级别的概念
        * 队列中的命令没有提交之前都不会被实际执行，因为没有事务提交钱任何指令都不会被实际执行
    * 不保证原子性
        * 事务中如果有一条命令执行失败，其后的命令仍然会被执行，不会回滚    
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
             